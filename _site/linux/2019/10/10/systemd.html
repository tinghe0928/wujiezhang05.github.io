<!DOCTYPE html>
<html lang="en-US">
  <head>

    
    <meta charset="UTF-8">

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Systemd探究</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Systemd探究" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="systemd： Linux的初始化系统。管理Linux 所有初始化进程（process ID 为1）的系统。1. 在server启动时，自动启动一些服务（sshd，firewall）等，2. 在server shutdown时，关闭这些服务。" />
<meta property="og:description" content="systemd： Linux的初始化系统。管理Linux 所有初始化进程（process ID 为1）的系统。1. 在server启动时，自动启动一些服务（sshd，firewall）等，2. 在server shutdown时，关闭这些服务。" />
<link rel="canonical" href="http://localhost:4000/linux/2019/10/10/systemd.html" />
<meta property="og:url" content="http://localhost:4000/linux/2019/10/10/systemd.html" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-10T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"systemd： Linux的初始化系统。管理Linux 所有初始化进程（process ID 为1）的系统。1. 在server启动时，自动启动一些服务（sshd，firewall）等，2. 在server shutdown时，关闭这些服务。","@type":"BlogPosting","url":"http://localhost:4000/linux/2019/10/10/systemd.html","headline":"Systemd探究","dateModified":"2019-10-10T00:00:00+08:00","datePublished":"2019-10-10T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/linux/2019/10/10/systemd.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>
    <a id="skip-to-content" href="#content">Skip to the content.</a>

    <header class="page-header" role="banner">
      <h1 class="project-name">Systemd探究</h1>
      <h2 class="project-tagline"></h2>
    </header>

    <main id="content" class="main-content" role="main">
      <h1 id="systemd">Systemd</h1>

<blockquote>
  <p>systemd： Linux的初始化系统。管理Linux 所有初始化进程（process ID 为1）的系统。</p>
  <ol>
    <li>在server启动时，自动启动一些服务（sshd，firewall）等，</li>
    <li>在server shutdown时，关闭这些服务。</li>
  </ol>
</blockquote>

<hr />

<h2 id="结构">结构</h2>

<p><img src="http://localhost:4000/images/systemd/systemd_structure.png" alt="" /></p>

<ol>
  <li>利用linux的crgoups来跟踪任务，当服务停止时，会通过查询cgroups找到所有相关的进程，从而干净的停止服务。
    <ul>
      <li>cgroups : 进程创建子进程时，子进程会继承父进程的cgroups。所以service不管怎么启动新的进程，所有的进程都会属于一个cgroups</li>
    </ul>
  </li>
  <li>
    <p>启动挂载点和自动挂载的管理</p>
  </li>
  <li>实现事务性依赖关系管理</li>
</ol>

<h2 id="unit-单元">unit 单元</h2>
<p>系统初始化要做很多事情，systemd把每一步都抽象为一个unit 配置单元，常见的配置单元</p>

<ol>
  <li>service: 代表一个后台进程。如mysql</li>
  <li>socket： 封装系统和互联网中的一个套接字，systemd支持流式，数据报，连续包的AF_INET,AF_INET6,AF_UNIX socket,
每一个套接字配置单元都有一个对应的service unit，对应的service会在第一个“连接”进入套接字时启动（如nscd.socket 在有新的连接后会启动nscd.service）</li>
  <li>device: 封装一个存在于linux设备树中的设备，每一个使用udev规则标记的设备在systemd中作为一个device unit出现</li>
  <li>target： 此类unit为其他unit进行逻辑分组，他们本身并不做什么，只是引用其他unit。如图形化界面的初始化需要很多unit，讲这些unit的组合组合为一个target。</li>
</ol>

<p>命令显示units 文件所在的路径。</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl show <span class="nt">--property</span><span class="o">=</span>UnitPath
</code></pre></div></div>
<p><strong>/usr/lib/systemd/system/</strong> 软件包安装的unit
<strong>/etc/systemd/system/</strong>  系统管理员安装的unit</p>

<h3 id="unit的-依赖关系">unit的 依赖关系</h3>
<p>systemd解除了大量启动工作的依赖关系，让unit可以并发启动。但有些unit确实存在依赖关系，可以在unit的定义中使用 <strong>require</strong> 来声明依赖关系。</p>

<h2 id="troubleshooting">troubleshooting</h2>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 寻找启动失败的unit</span>
systemctl <span class="nt">--state</span><span class="o">=</span>failed
<span class="c"># 寻找启动失败的unit</span>
journalctl <span class="nt">-fp</span> err

<span class="c">#查看unit systemd-modules-load的状态</span>
systemctl status systemd-modules-load

<span class="c">#通过PID 查询错误内容</span>
journalctl <span class="nt">-b</span> <span class="nv">_PID</span><span class="o">=</span>15630

</code></pre></div></div>
<p>debug一个unit。在此unit的配置文件中加</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Service]
<span class="nv">Environment</span><span class="o">=</span><span class="nv">SYSTEMD_LOG_LEVEL</span><span class="o">=</span>debug
</code></pre></div></div>


      <footer class="site-footer">
        
      </footer>
    </main>
  </body>
</html>