<!DOCTYPE html>
<html>
  <head>
    <title>使用XSLT 格式化 XML – Your Name – Web Developer from Somewhere</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="在平常工作中经常遇到要求对 XML 进行格式化的情况， XSLT相比较于写纯java代码操作 org.w3c.dom.Document 更加方便，利于维护。下面会用一个java例子来介绍XSLT的基本用法。" />
    <meta property="og:description" content="在平常工作中经常遇到要求对 XML 进行格式化的情况， XSLT相比较于写纯java代码操作 org.w3c.dom.Document 更加方便，利于维护。下面会用一个java例子来介绍XSLT的基本用法。" />
    
    <meta name="author" content="Your Name" />

    
    <meta property="og:title" content="使用XSLT 格式化 XML" />
    <meta property="twitter:title" content="使用XSLT 格式化 XML" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="http://localhost:4000/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Your Name - Web Developer from Somewhere" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://raw.githubusercontent.com/barryclark/jekyll-now/master/images/jekyll-logo.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Your Name</a></h1>
            <p class="site-description">Web Developer from Somewhere</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <p>#使用 XSLT  格式化 XML</p>

<blockquote>
  <p>在平常工作中经常遇到要求对 XML 进行格式化的情况， XSLT相比较于写纯java代码操作 org.w3c.dom.Document 更加方便，利于维护。
下面会用一个java例子来介绍XSLT的基本用法。</p>
</blockquote>

<h2 id="场景">场景</h2>
<p>原始的XML</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;school&gt;</span>
	<span class="nt">&lt;students&gt;</span>
		<span class="nt">&lt;student&gt;</span>
			<span class="nt">&lt;name&gt;</span>Lucy<span class="nt">&lt;/name&gt;</span>
			<span class="nt">&lt;gender&gt;</span>Female<span class="nt">&lt;/gender&gt;</span>
		<span class="nt">&lt;/student&gt;</span>
		<span class="nt">&lt;student&gt;</span>
			<span class="nt">&lt;name&gt;</span>Lily<span class="nt">&lt;/name&gt;</span>
			<span class="nt">&lt;gender&gt;</span>Female<span class="nt">&lt;/gender&gt;</span>
		<span class="nt">&lt;/student&gt;</span>
		<span class="nt">&lt;student&gt;</span>
			<span class="nt">&lt;name&gt;</span>Tom<span class="nt">&lt;/name&gt;</span>
			<span class="nt">&lt;gender&gt;</span>Male<span class="nt">&lt;/gender&gt;</span>
		<span class="nt">&lt;/student&gt;</span>
	<span class="nt">&lt;/students&gt;</span>
<span class="nt">&lt;/school&gt;</span>
</code></pre></div></div>
<p>想要把所有的女性选出来 放入下面的xml结构中</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;cityMall&gt;</span>
	<span class="nt">&lt;store&gt;</span>
	    <span class="nt">&lt;name&gt;</span>Lucy<span class="nt">&lt;/name&gt;</span>
	    <span class="nt">&lt;name&gt;</span>Lily<span class="nt">&lt;/name&gt;</span>
	<span class="nt">&lt;/store&gt;</span>
<span class="nt">&lt;/cityMall&gt;</span>
</code></pre></div></div>
<p>怎么用XSLT 实现这种转化呢。
如下 XSLT - formater.xml</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;xsl:stylesheet</span> <span class="na">version=</span><span class="s">"1.0"</span>
	<span class="na">xmlns:xsl=</span><span class="s">"http://www.w3.org/1999/XSL/Transform"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;xsl:output</span> <span class="na">method=</span><span class="s">"xml"</span> <span class="na">omit-xml-declaration=</span><span class="s">"yes"</span>
		<span class="na">encoding=</span><span class="s">"UTF-8"</span> <span class="na">indent=</span><span class="s">"yes"</span> <span class="nt">/&gt;</span>
	<span class="c">&lt;!-- GLOBAL VARIABLES --&gt;</span>
	<span class="nt">&lt;xsl:variable</span> <span class="na">name=</span><span class="s">"target"</span> <span class="na">select=</span><span class="s">"/school/students"</span> <span class="nt">/&gt;</span>

	<span class="c">&lt;!-- transform template --&gt;</span>
	<span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">"/"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;cityMall&gt;</span>
			<span class="nt">&lt;store&gt;</span>
				<span class="nt">&lt;xsl:for-each</span> <span class="na">select=</span><span class="s">"$target/student"</span><span class="nt">&gt;</span>
					<span class="nt">&lt;xsl:if</span> <span class="na">test=</span><span class="s">"(boolean(gender ='Female'))"</span><span class="nt">&gt;</span>
						<span class="nt">&lt;xsl:copy-of</span> <span class="na">select=</span><span class="s">"name"</span><span class="nt">&gt;&lt;/xsl:copy-of&gt;</span>
					<span class="nt">&lt;/xsl:if&gt;</span>
				<span class="nt">&lt;/xsl:for-each&gt;</span>
			<span class="nt">&lt;/store&gt;</span>
		<span class="nt">&lt;/cityMall&gt;</span>
	<span class="nt">&lt;/xsl:template&gt;</span>
<span class="nt">&lt;/xsl:stylesheet&gt;</span>
</code></pre></div></div>
<p>遍历所有的 student element， 发现geneder为Female时，选择它。</p>

<p>怎么使用JAVA 调用它呢。</p>

<p>Formater.java</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilderFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.ParserConfigurationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.TransformerConfigurationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.TransformerException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.TransformerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.dom.DOMResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.dom.DOMSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.stream.StreamResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.io.output.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.w3c.dom.Document</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ericsson.dve.jdv.m2m.core.util.M2MTransformerFactory</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Formater</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="no">LOGGER</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">M2MTransformerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Formater</span> <span class="n">formater</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Formater</span><span class="o">();</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="n">formater</span><span class="o">.</span><span class="na">getSrcDocument</span><span class="o">(</span><span class="s">"test/META-INF/source.xml"</span><span class="o">);</span>

			<span class="nc">Document</span> <span class="n">transformedResponse</span> <span class="o">=</span> <span class="n">formater</span><span class="o">.</span><span class="na">transformDoc</span><span class="o">(</span><span class="n">document</span><span class="o">);</span>

			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">formater</span><span class="o">.</span><span class="na">xml2Str</span><span class="o">(</span><span class="n">transformedResponse</span><span class="o">));</span>

		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Exception"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span>

	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">Document</span> <span class="nf">getSrcDocument</span><span class="o">(</span><span class="nc">String</span> <span class="n">srcFilePath</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SAXException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ParserConfigurationException</span> <span class="o">{</span>
		<span class="nc">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">File</span> <span class="n">srcDocFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"test/META-INF/source.xml"</span><span class="o">);</span>
		<span class="nc">DocumentBuilderFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="nc">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
		<span class="nc">DocumentBuilder</span> <span class="n">builder</span><span class="o">;</span>
		<span class="n">builder</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
		<span class="n">document</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">srcDocFile</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">document</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">Document</span> <span class="nf">transformDoc</span><span class="o">(</span><span class="nc">Document</span> <span class="n">srcDoc</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransformerConfigurationException</span><span class="o">,</span> <span class="nc">TransformerException</span> <span class="o">{</span>
		<span class="nc">DOMResult</span> <span class="n">tResult</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DOMResult</span><span class="o">();</span>

		<span class="nc">M2MTransformerFactory</span><span class="o">.</span><span class="na">getTransformer</span><span class="o">(</span><span class="s">"/META-INF/xslt/NewFile2.xml"</span><span class="o">).</span><span class="na">transform</span><span class="o">(</span><span class="k">new</span> <span class="nc">DOMSource</span><span class="o">(</span><span class="n">srcDoc</span><span class="o">),</span> <span class="n">tResult</span><span class="o">);</span>

		<span class="nc">Document</span> <span class="n">transformedResponse</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Document</span><span class="o">)</span> <span class="n">tResult</span><span class="o">.</span><span class="na">getNode</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">transformedResponse</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">String</span> <span class="nf">xml2Str</span><span class="o">(</span><span class="nc">Document</span> <span class="n">document</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransformerException</span> <span class="o">{</span>
		<span class="nc">TransformerFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="nc">TransformerFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
		<span class="nc">Transformer</span> <span class="n">transformer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">newTransformer</span><span class="o">();</span>

		<span class="nc">ByteArrayOutputStream</span> <span class="n">byteArrayOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>

		<span class="n">transformer</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="k">new</span> <span class="nc">DOMSource</span><span class="o">(</span><span class="n">document</span><span class="o">),</span> <span class="k">new</span> <span class="nc">StreamResult</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">));</span>

		<span class="k">return</span> <span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>TransformerFactory.java</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.Source</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.TransformerConfigurationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.TransformerException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.URIResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.stream.StreamSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransformerFactory</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="no">LOGGER</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">TransformerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="n">javax</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">transform</span><span class="o">.</span><span class="na">TransformerFactory</span> <span class="n">factory</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="nc">Transformer</span> <span class="n">transformer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

	<span class="kd">static</span> <span class="o">{</span>
		<span class="n">factory</span> <span class="o">=</span> <span class="n">javax</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">transform</span><span class="o">.</span><span class="na">TransformerFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">setURIResolver</span><span class="o">(</span><span class="k">new</span> <span class="nc">XsltURIResolver</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nf">TransformerFactory</span><span class="o">()</span> <span class="o">{</span>

	<span class="o">}</span>

	<span class="cm">/**
	 * Creates Transformer from the file passed as argument.
	 *
	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Transformer</span> <span class="nf">getTransformer</span><span class="o">(</span><span class="nc">String</span> <span class="n">xsltFileName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransformerConfigurationException</span> <span class="o">{</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">xsltFileName</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">xsltFileName</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"xslFileName argument must not be null"</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">factory</span><span class="o">.</span><span class="na">newTransformer</span><span class="o">(</span>
						<span class="k">new</span> <span class="nf">StreamSource</span><span class="o">(</span><span class="nc">TransformerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="n">xsltFileName</span><span class="o">)));</span>
			<span class="o">}</span>

			<span class="k">return</span> <span class="n">transformer</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TransformerConfigurationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error creating xsl Transformer for file: {}"</span><span class="o">,</span> <span class="n">xsltFileName</span><span class="o">);</span>
			<span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
		<span class="o">}</span>

	<span class="o">}</span>

	<span class="cm">/**
	 * Transformer factory URI resolver
	 *
	 */</span>
	<span class="kd">static</span> <span class="kd">class</span> <span class="nc">XsltURIResolver</span> <span class="kd">implements</span> <span class="nc">URIResolver</span> <span class="o">{</span>

		<span class="kd">public</span> <span class="nc">Source</span> <span class="nf">resolve</span><span class="o">(</span><span class="nc">String</span> <span class="n">href</span><span class="o">,</span> <span class="nc">String</span> <span class="n">base</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransformerException</span> <span class="o">{</span>

			<span class="nc">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="nc">TransformerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"/META-INF/xslt/"</span> <span class="o">+</span> <span class="n">href</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">is</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">TransformerException</span><span class="o">(</span><span class="s">"Transformation file "</span> <span class="o">+</span> <span class="n">href</span> <span class="o">+</span> <span class="s">" not found"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">StreamSource</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><strong>Note: formater.xml 应该放在Transformer.java 的相对路径 /META-INF/xslt/ 下面</strong></p>

<p>之后如果需要不同格式的document，都可以直接修改formater.xml 来完成。 不仅直观，后续维护也更加方便。</p>

<p>##XSLT 其他用法</p>
<ul>
  <li>chose, when ,otherwise. 进行逻辑判断。
```xml</li>
</ul>
<xsl:choose>
	<xsl:when test="ResultData">
		<xsl:copy-of select="ResultData/*"></xsl:copy-of>
	</xsl:when>
	<xsl:otherwise>
		<xsl:copy-of select="*"></xsl:copy-of>
	</xsl:otherwise>
</xsl:choose>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-  xls:if xsl:element 动态的生成xml的element. 
```xml
&lt;xsl:if test="not(boolean(/school/student/name =''))"&gt;
	&lt;xsl:element name="new_name"&gt;
		&lt;xsl:value-of select="/school/student/name"&gt;&lt;/xsl:value-of&gt;
	&lt;/xsl:element&gt;
&lt;/xsl:if&gt;
</code></pre></div></div>

<p>优点：XSLT 还有很多其他用法方便xml的处理。特别适合于业务逻辑复杂的转换，
劣势：t比单纯的java 处理 org.w3c.dom.Document 处理速度慢。 但我并没有进行大量实验就行分析对比。只是在使用过程中发现 performance略有不足。</p>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/barryclark/jekyll-now"><i class="svg-icon github"></i></a>




<a href="https://www.twitter.com/jekyllrb"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    

  </body>
</html>
